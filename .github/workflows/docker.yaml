name: SPlayer 全自动构建及容器化

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: '发布名称（留空自动生成）'
        required: false
        type: string
  schedule:
    - cron: '0 0 * * 1'  # 每周一 UTC 时间 0 点执行

env:
  PROJECT_DIR: SPlayer
  DOCKER_IMAGE_NAME: splayer-pro

jobs:
  precise-build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    # ========== 1. 克隆代码（含历史记录） ==========
    - name: 克隆仓库
      uses: actions/checkout@v4
      with:
        repository: IamFurina/SPlayer
        ref: master-fix
        fetch-depth: 0  # 获取完整提交历史
        persist-credentials: true  # 保留推送权限

    # ========== 2. 获取最新tag ==========
    - name: 获取最新tag
      id: get-tag
      run: |
        git fetch --tags
        LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1))
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "CURRENT_TAG=$LATEST_TAG" >> $GITHUB_ENV

    # ========== 3. 初始化缓存目录 ==========
    - name: 创建缓存目录
      run: mkdir -p cache

    # ========== 4. 首次运行处理 ==========
    - name: 检查并创建tag文件
      id: init-tag-file
      run: |
        if [ ! -f cache/tag.md ]; then
          echo "首次运行，创建tag文件"
          echo "${{ env.CURRENT_TAG }}" > cache/tag.md
          
          # 提交文件到仓库
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add cache/tag.md
          git commit -m "chore: 初始化tag记录文件"
          git push
          
          echo "首次运行已记录tag并提交到仓库"
          exit 0
        fi

    # ========== 5. 终止首次运行 ==========
    - name: 结束首次运行
      if: steps.init-tag-file.outcome == 'success' && env.CURRENT_TAG != ''
      run: exit 0

    # ========== 6. 检查tag更新 ==========
    - name: 对比tag版本
      run: |
        echo "当前最新tag: ${{ env.CURRENT_TAG }}"
        echo "记录的旧tag: $(cat cache/tag.md)"
        
        if [ "${{ env.CURRENT_TAG }}" == "$(cat cache/tag.md)" ]; then
          echo "没有新tag，终止流程"
          exit 1
        else
          echo "检测到新tag，准备更新文件"
          echo "${{ env.CURRENT_TAG }}" > cache/tag.md
          
          # 更新文件到仓库
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add cache/tag.md
          git commit -m "chore: 更新tag记录到${{ env.CURRENT_TAG }}"
          git push
        fi

    # ========== 3. 配置运行时 ==========
    - name: 安装最新Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 'latest'

    - name: 安装最新pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    # ========== 4. 环境变量配置 ========== 
    - name: 配置环境变量 (Python精确处理)
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        cp -p .env.example .env
        python <<"EOF"
        # 原Python脚本保持不变
        EOF

    # ========== 5. 安装依赖 ==========
    - name: 安装项目依赖
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        # 原依赖安装脚本保持不变

    # ========== 6. 构建项目 ==========
    - name: 执行构建
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        # 原构建脚本保持不变

    # ========== 7. 生成Dockerfile ==========
    - name: 创建精简Dockerfile
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        # 原Dockerfile生成脚本保持不变

    # ========== 8. 构建Docker镜像 ==========
    - name: 打包Docker镜像
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        # 动态生成镜像名称
        TAG_NAME="${{ steps.get-tag.outputs.LATEST_TAG }}"
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:$TAG_NAME -f Dockerfile.auto .
        
        # 保存镜像文件（包含tag名）
        mkdir -p release
        docker save -o release/splayer-docker-$TAG_NAME.tar ${{ env.DOCKER_IMAGE_NAME }}:$TAG_NAME

    # ========== 9. 创建发布包 ==========
    - name: 打包构建产物
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        RELEASE_NAME="${{ steps.get-tag.outputs.LATEST_TAG }}"
        mkdir -p release/${RELEASE_NAME}
        cp -r out/renderer/* release/${RELEASE_NAME}
        tar -czvf release/${RELEASE_NAME}.tar.gz -C release ${RELEASE_NAME}

    # ========== 10. 发布产物 ==========
    - name: 上传到GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "${{ steps.get-tag.outputs.LATEST_TAG }}"
        tag_name: "${{ steps.get-tag.outputs.LATEST_TAG }}"
        body: |
          ## 构建信息
          - 触发方式: ${{ github.event_name }}
          - 构建时间: ${{ github.run_started_at }}
          - 镜像Tag: ${{ steps.get-tag.outputs.LATEST_TAG }}
          
          ## 使用说明
          ```bash
          docker load -i splayer-docker-${{ steps.get-tag.outputs.LATEST_TAG }}.tar
          docker run -p 80:80 ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.get-tag.outputs.LATEST_TAG }}
          ```
        files: |
          ${{ env.PROJECT_DIR }}/release/*.tar.gz
          ${{ env.PROJECT_DIR }}/release/splayer-docker-*.tar
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
